<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>myUCLAhealth - Message Center</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #003366 0%, #0066cc 100%);
            color: white;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
            padding: 12px 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 18px;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: #0066cc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border: 2px solid rgba(255,255,255,0.3);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 58px);
            max-width: 1400px;
            margin: 0 auto;
            background: white;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }

        .compose-btn {
            margin: 20px;
            padding: 12px 24px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .compose-btn:hover {
            background: #0052a3;
        }

        .folder-list {
            flex: 1;
            overflow-y: auto;
        }

        .folder-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .folder-item:hover {
            background: #e9ecef;
        }

        .folder-item.active {
            background: #e3f2fd;
            border-left: 3px solid #0066cc;
        }

        .folder-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            color: #6c757d;
        }

        .folder-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }

        .folder-count {
            background: #dc3545;
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        /* Message List */
        .message-list-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e9ecef;
        }

        .message-list-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
        }

        .search-bar input {
            flex: 1;
            border: none;
            background: none;
            outline: none;
            font-size: 14px;
            margin-left: 8px;
        }

        .message-list {
            flex: 1;
            overflow-y: auto;
        }

        .message-item {
            display: flex;
            padding: 16px 20px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .message-item:hover {
            background: #f8f9fa;
        }

        .message-item.active {
            background: #e3f2fd;
        }

        .message-item.unread {
            background: #fff;
            font-weight: 600;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #6c757d;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .message-sender {
            font-size: 14px;
            font-weight: 600;
            color: #212529;
        }

        .message-time {
            font-size: 12px;
            color: #6c757d;
        }

        .message-subject {
            font-size: 14px;
            color: #212529;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-preview {
            font-size: 13px;
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-indicators {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }

        .indicator {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #e9ecef;
            color: #6c757d;
        }

        .indicator.attachment {
            background: #d4edda;
            color: #155724;
        }

        .indicator.urgent {
            background: #f8d7da;
            color: #721c24;
        }

        /* Conversation View */
        .conversation-container {
            flex: 2;
            display: flex;
            flex-direction: column;
        }

        .conversation-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: #fff;
        }

        .conversation-title {
            font-size: 20px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 8px;
        }

        .conversation-info {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 14px;
            color: #6c757d;
        }

        .conversation-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message-bubble {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message-bubble.sent {
            flex-direction: row-reverse;
        }

        .bubble-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #6c757d;
            flex-shrink: 0;
        }

        .bubble-content {
            max-width: 70%;
        }

        .bubble-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 13px;
            color: #6c757d;
        }

        .bubble-message {
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message-bubble.sent .bubble-message {
            background: #0066cc;
            color: white;
        }

        .bubble-attachments {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 13px;
            color: #495057;
            text-decoration: none;
            transition: background 0.2s;
        }

        .attachment-item:hover {
            background: #dee2e6;
        }

        /* Compose Area */
        .compose-area {
            border-top: 1px solid #e9ecef;
            background: white;
            padding: 20px;
        }

        .compose-tools {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .tool-btn {
            padding: 6px 10px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .compose-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            resize: vertical;
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }

        .compose-input:focus {
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0,102,204,0.1);
        }

        .compose-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
        }

        .compose-options {
            display: flex;
            gap: 10px;
        }

        .send-btn {
            padding: 8px 20px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .send-btn:hover {
            background: #0052a3;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* New Message Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #495057;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }

        .form-input:focus {
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0,102,204,0.1);
        }

        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-primary {
            background: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #dc3545;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0066cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }

            .message-list-container {
                border-right: none;
            }

            .conversation-container {
                display: none;
            }

            .conversation-container.mobile-show {
                display: flex;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                z-index: 100;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="logo">myUCLAhealth - Message Center</div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar">R</div>
                    <span>Rachel Li</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <button class="compose-btn" onclick="openNewMessage()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
                </svg>
                New Message
            </button>
            
            <nav class="folder-list">
                <div class="folder-item active" onclick="selectFolder('inbox')">
                    <svg class="folder-icon" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.98 4a.5.5 0 0 0-.39.188L1.54 8H6a.5.5 0 0 1 .5.5 1.5 1.5 0 1 0 3 0A.5.5 0 0 1 10 8h4.46l-3.05-3.812A.5.5 0 0 0 11.02 4H4.98zm9.954 5H10.45a2.5 2.5 0 0 1-4.9 0H1.066l.32 2.562a.5.5 0 0 0 .497.438h12.234a.5.5 0 0 0 .496-.438L14.933 9zM3.809 3.563A1.5 1.5 0 0 1 4.981 3h6.038a1.5 1.5 0 0 1 1.172.563l3.7 4.625a.5.5 0 0 1 .105.374l-.39 3.124A1.5 1.5 0 0 1 14.117 13H1.883a1.5 1.5 0 0 1-1.489-1.314l-.39-3.124a.5.5 0 0 1 .106-.374l3.7-4.625z"/>
                    </svg>
                    <span class="folder-name">Inbox</span>
                    <span class="folder-count" id="inbox-count">3</span>
                </div>
                
                <div class="folder-item" onclick="selectFolder('sent')">
                    <svg class="folder-icon" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                    </svg>
                    <span class="folder-name">Sent</span>
                </div>
                
                <div class="folder-item" onclick="selectFolder('drafts')">
                    <svg class="folder-icon" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5 10.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                        <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2z"/>
                        <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1z"/>
                    </svg>
                    <span class="folder-name">Drafts</span>
                    <span class="folder-count hidden" id="drafts-count">0</span>
                </div>
                
                <div class="folder-item" onclick="selectFolder('archived')">
                    <svg class="folder-icon" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M0 2a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5a2.5 2.5 0 0 1-2.5 2.5h-9A2.5 2.5 0 0 1 1 12.5V5a1 1 0 0 1-1-1V2zm2 3v7.5A1.5 1.5 0 0 0 3.5 14h9a1.5 1.5 0 0 0 1.5-1.5V5H2zm13-3H1v2h14V2zM5 7.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                    </svg>
                    <span class="folder-name">Archived</span>
                </div>
            </nav>
        </aside>

        <!-- Message List -->
        <div class="message-list-container">
            <div class="message-list-header">
                <div class="search-bar">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                    <input type="text" placeholder="Search messages..." id="searchInput">
                </div>
            </div>
            
            <div class="message-list" id="messageList">
                <!-- Messages will be populated here -->
            </div>
        </div>

        <!-- Conversation View -->
        <div class="conversation-container" id="conversationView">
            <div class="empty-state">
                <div class="empty-icon">üí¨</div>
                <p>Select a message to view conversation</p>
            </div>
        </div>
    </div>

    <!-- New Message Modal -->
    <div class="modal-overlay hidden" id="newMessageModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">New Message</h3>
                <button class="modal-close" onclick="closeNewMessage()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">To:</label>
                    <select class="form-select" id="recipientSelect">
                        <option value="">Select a provider...</option>
                        <option value="dr-pang">Dr. Clifford Pang, DO - Primary Care</option>
                        <option value="dr-mayo">Dr. Mary C. Mayo, MD - Specialist</option>
                        <option value="dr-bose">Dr. Vivek Bose, MD - Cardiology</option>
                        <option value="dr-cooke">Dr. Richard R. Cooke, II, MD - Internal Medicine</option>
                        <option value="nurse">Nursing Staff</option>
                        <option value="pharmacy">Pharmacy</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Subject:</label>
                    <input type="text" class="form-input" id="subjectInput" placeholder="Enter subject...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message Type:</label>
                    <select class="form-select" id="messageType">
                        <option value="general">General Question</option>
                        <option value="medication">Medication Question</option>
                        <option value="appointment">Appointment Request</option>
                        <option value="results">Test Results Question</option>
                        <option value="refill">Prescription Refill</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message:</label>
                    <textarea class="form-input" id="messageInput" rows="6" placeholder="Type your message..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeNewMessage()">Cancel</button>
                <button class="btn btn-primary" onclick="sendNewMessage()">Send Message</button>
            </div>
        </div>
    </div>

    <script>
        // Message data store
        let messages = [
            {
                id: 1,
                folder: 'inbox',
                sender: 'Dr. Clifford Pang, DO',
                senderRole: 'Primary Care Physician',
                subject: 'Follow-up on Recent Lab Results',
                preview: 'Hi Rachel, I\'ve reviewed your recent lab results and everything looks good. Your cholesterol levels have improved...',
                time: '2 hours ago',
                unread: true,
                urgent: false,
                hasAttachment: true,
                conversation: [
                    {
                        id: 'msg1',
                        sender: 'Dr. Clifford Pang, DO',
                        time: '2 hours ago',
                        message: 'Hi Rachel,\n\nI\'ve reviewed your recent lab results and everything looks good. Your cholesterol levels have improved since our last check, and your blood sugar is within normal range.\n\nKeep up the good work with your diet and exercise routine. Let\'s schedule a follow-up appointment in 3 months to monitor your progress.\n\nBest regards,\nDr. Pang',
                        attachments: [
                            { name: 'Lab_Results_2025.pdf', size: '245 KB' }
                        ]
                    }
                ]
            },
            {
                id: 2,
                folder: 'inbox',
                sender: 'Pharmacy',
                senderRole: 'UCLA Medical Center Pharmacy',
                subject: 'Prescription Ready for Pickup',
                preview: 'Your prescription for Lisinopril is ready for pickup at the UCLA Medical Center Pharmacy...',
                time: '5 hours ago',
                unread: true,
                urgent: true,
                hasAttachment: false,
                conversation: [
                    {
                        id: 'msg2',
                        sender: 'Pharmacy',
                        time: '5 hours ago',
                        message: 'Dear Rachel Li,\n\nYour prescription is ready for pickup:\n\nMedication: Lisinopril 10mg\nQuantity: 30 tablets\nPharmacy: UCLA Medical Center Pharmacy\nPickup hours: Mon-Fri 8am-6pm, Sat 9am-2pm\n\nPlease bring your ID when picking up your medication.\n\nIf you have any questions, please call us at (310) 825-6301.\n\nThank you,\nUCLA Pharmacy Team'
                    }
                ]
            },
            {
                id: 3,
                folder: 'inbox',
                sender: 'Appointment Reminder',
                senderRole: 'System',
                subject: 'Upcoming Appointment - July 15, 2025',
                preview: 'This is a reminder about your upcoming appointment with Dr. Mayo on July 15, 2025 at 2:30 PM...',
                time: 'Yesterday',
                unread: false,
                urgent: false,
                hasAttachment: false,
                conversation: [
                    {
                        id: 'msg3',
                        sender: 'Appointment Reminder',
                        time: 'Yesterday',
                        message: 'Dear Rachel,\n\nThis is a reminder about your upcoming appointment:\n\nProvider: Dr. Mary C. Mayo, MD\nDate: Tuesday, July 15, 2025\nTime: 2:30 PM\nLocation: UCLA Medical Plaza, Suite 200\nType: Follow-up Visit\n\nPlease arrive 15 minutes early to complete any necessary paperwork.\n\nTo cancel or reschedule, please call (310) 825-2631 at least 24 hours in advance.\n\nThank you,\nUCLA Health Scheduling'
                    }
                ]
            }
        ];

        let currentFolder = 'inbox';
        let currentMessageId = null;
        let websocket = null;

        // Initialize WebSocket for real-time updates
        function initWebSocket() {
            const patientId = 'patient-' + Math.random().toString(36).substr(2, 9);
            websocket = new WebSocket(`ws://localhost:3001/messaging?patientId=${patientId}`);

            websocket.onopen = () => {
                console.log('Messaging WebSocket connected');
            };

            websocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                switch(data.type) {
                    case 'newMessage':
                        addNewMessage(data.message);
                        showNotification('New message received');
                        break;
                    case 'messageRead':
                        markMessageAsRead(data.messageId);
                        break;
                }
            };

            websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            websocket.onclose = () => {
                // Attempt to reconnect after 5 seconds
                setTimeout(initWebSocket, 5000);
            };
        }

        // Initialize the messaging board
        function init() {
            renderMessageList();
            updateUnreadCount();
            initWebSocket();
            
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', (e) => {
                searchMessages(e.target.value);
            });
        }

        // Render message list
        function renderMessageList() {
            const messageList = document.getElementById('messageList');
            const folderMessages = messages.filter(m => m.folder === currentFolder);
            
            if (folderMessages.length === 0) {
                messageList.innerHTML = `
                    <div class="empty-state" style="padding: 40px;">
                        <div class="empty-icon">üì≠</div>
                        <p>No messages in ${currentFolder}</p>
                    </div>
                `;
                return;
            }
            
            messageList.innerHTML = folderMessages.map(message => `
                <div class="message-item ${message.unread ? 'unread' : ''} ${currentMessageId === message.id ? 'active' : ''}" 
                     onclick="viewMessage(${message.id})">
                    <div class="message-avatar">${message.sender.charAt(0)}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">${message.sender}</span>
                            <span class="message-time">${message.time}</span>
                        </div>
                        <div class="message-subject">${message.subject}</div>
                        <div class="message-preview">${message.preview}</div>
                        <div class="message-indicators">
                            ${message.urgent ? '<span class="indicator urgent">Urgent</span>' : ''}
                            ${message.hasAttachment ? '<span class="indicator attachment">üìé Attachment</span>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // View message conversation
        function viewMessage(messageId) {
            currentMessageId = messageId;
            const message = messages.find(m => m.id === messageId);
            
            if (!message) return;
            
            // Mark as read
            if (message.unread) {
                message.unread = false;
                updateUnreadCount();
                renderMessageList();
            }
            
            const conversationView = document.getElementById('conversationView');
            conversationView.innerHTML = `
                <div class="conversation-header">
                    <h2 class="conversation-title">${message.subject}</h2>
                    <div class="conversation-info">
                        <span>From: ${message.sender}</span>
                        <span>${message.senderRole}</span>
                    </div>
                </div>
                
                <div class="conversation-messages">
                    ${message.conversation.map(msg => `
                        <div class="message-bubble ${msg.sender === 'You' ? 'sent' : ''}">
                            <div class="bubble-avatar">${msg.sender === 'You' ? 'R' : msg.sender.charAt(0)}</div>
                            <div class="bubble-content">
                                <div class="bubble-header">
                                    <span>${msg.sender}</span>
                                    <span>${msg.time}</span>
                                </div>
                                <div class="bubble-message">${msg.message.replace(/\n/g, '<br>')}</div>
                                ${msg.attachments ? `
                                    <div class="bubble-attachments">
                                        ${msg.attachments.map(att => `
                                            <a href="#" class="attachment-item" onclick="downloadAttachment('${att.name}')">
                                                üìÑ ${att.name} (${att.size})
                                            </a>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="compose-area">
                    <div class="compose-tools">
                        <button class="tool-btn" onclick="attachFile()">üìé Attach</button>
                        <button class="tool-btn" onclick="insertTemplate()">üìù Template</button>
                    </div>
                    <textarea class="compose-input" id="replyInput" placeholder="Type your reply..."></textarea>
                    <div class="compose-actions">
                        <div class="compose-options">
                            <label>
                                <input type="checkbox" id="urgentCheck"> Mark as urgent
                            </label>
                        </div>
                        <button class="send-btn" onclick="sendReply(${messageId})">Send Reply</button>
                    </div>
                </div>
            `;
        }

        // Send reply
        function sendReply(messageId) {
            const replyText = document.getElementById('replyInput').value.trim();
            if (!replyText) return;
            
            const message = messages.find(m => m.id === messageId);
            const newReply = {
                id: 'msg' + Date.now(),
                sender: 'You',
                time: 'Just now',
                message: replyText
            };
            
            message.conversation.push(newReply);
            
            // Send via WebSocket
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'sendMessage',
                    messageId: messageId,
                    reply: newReply
                }));
            }
            
            viewMessage(messageId);
            showNotification('Message sent');
        }

        // Open new message modal
        function openNewMessage() {
            document.getElementById('newMessageModal').classList.remove('hidden');
        }

        // Close new message modal
        function closeNewMessage() {
            document.getElementById('newMessageModal').classList.add('hidden');
            // Clear form
            document.getElementById('recipientSelect').value = '';
            document.getElementById('subjectInput').value = '';
            document.getElementById('messageType').value = 'general';
            document.getElementById('messageInput').value = '';
        }

        // Send new message
        function sendNewMessage() {
            const recipient = document.getElementById('recipientSelect').value;
            const subject = document.getElementById('subjectInput').value;
            const messageType = document.getElementById('messageType').value;
            const messageText = document.getElementById('messageInput').value;
            
            if (!recipient || !subject || !messageText) {
                alert('Please fill in all fields');
                return;
            }
            
            const recipientName = document.getElementById('recipientSelect').selectedOptions[0].text;
            
            const newMessage = {
                id: messages.length + 1,
                folder: 'sent',
                sender: 'You',
                recipient: recipientName,
                subject: subject,
                preview: messageText.substring(0, 100) + '...',
                time: 'Just now',
                unread: false,
                urgent: false,
                hasAttachment: false,
                conversation: [
                    {
                        id: 'msg' + Date.now(),
                        sender: 'You',
                        time: 'Just now',
                        message: messageText
                    }
                ]
            };
            
            messages.unshift(newMessage);
            
            // Send via WebSocket
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'newMessage',
                    message: newMessage
                }));
            }
            
            closeNewMessage();
            selectFolder('sent');
            showNotification('Message sent successfully');
        }

        // Select folder
        function selectFolder(folder) {
            currentFolder = folder;
            currentMessageId = null;
            
            // Update UI
            document.querySelectorAll('.folder-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.folder-item').classList.add('active');
            
            renderMessageList();
            
            // Clear conversation view
            document.getElementById('conversationView').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üí¨</div>
                    <p>Select a message to view conversation</p>
                </div>
            `;
        }

        // Update unread count
        function updateUnreadCount() {
            const unreadCount = messages.filter(m => m.folder === 'inbox' && m.unread).length;
            const countElement = document.getElementById('inbox-count');
            
            if (unreadCount > 0) {
                countElement.textContent = unreadCount;
                countElement.classList.remove('hidden');
            } else {
                countElement.classList.add('hidden');
            }
        }

        // Search messages
        function searchMessages(query) {
            if (!query) {
                renderMessageList();
                return;
            }
            
            const filtered = messages.filter(m => 
                m.folder === currentFolder && (
                    m.subject.toLowerCase().includes(query.toLowerCase()) ||
                    m.sender.toLowerCase().includes(query.toLowerCase()) ||
                    m.preview.toLowerCase().includes(query.toLowerCase())
                )
            );
            
            const messageList = document.getElementById('messageList');
            
            if (filtered.length === 0) {
                messageList.innerHTML = `
                    <div class="empty-state" style="padding: 40px;">
                        <div class="empty-icon">üîç</div>
                        <p>No messages found</p>
                    </div>
                `;
                return;
            }
            
            messageList.innerHTML = filtered.map(message => `
                <div class="message-item ${message.unread ? 'unread' : ''}" onclick="viewMessage(${message.id})">
                    <div class="message-avatar">${message.sender.charAt(0)}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">${message.sender}</span>
                            <span class="message-time">${message.time}</span>
                        </div>
                        <div class="message-subject">${message.subject}</div>
                        <div class="message-preview">${message.preview}</div>
                    </div>
                </div>
            `).join('');
        }

        // Show notification
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Attach file (placeholder)
        function attachFile() {
            alert('File attachment feature coming soon');
        }

        // Insert template (placeholder)
        function insertTemplate() {
            const templates = [
                'Thank you for your message. I will follow up as instructed.',
                'I have a question about my recent test results.',
                'I would like to schedule a follow-up appointment.',
                'Could you please refill my prescription?'
            ];
            
            const selected = prompt('Select a template:\n\n' + templates.map((t, i) => `${i + 1}. ${t}`).join('\n'));
            if (selected && templates[selected - 1]) {
                document.getElementById('replyInput').value = templates[selected - 1];
            }
        }

        // Download attachment (placeholder)
        function downloadAttachment(filename) {
            alert(`Downloading ${filename}...`);
        }

        // Add new message to list
        function addNewMessage(message) {
            messages.unshift(message);
            if (currentFolder === message.folder) {
                renderMessageList();
            }
            updateUnreadCount();
        }

        // Mark message as read
        function markMessageAsRead(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (message) {
                message.unread = false;
                updateUnreadCount();
                if (currentFolder === message.folder) {
                    renderMessageList();
                }
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>